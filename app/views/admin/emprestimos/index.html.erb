<h1 class="mb-4 text-primary">üìö Hist√≥rico de Empr√©stimos</h1>

<div class="card border-0 shadow-sm mb-4">
  <div class="card-body d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
    <div class="btn-group" role="group" aria-label="Exporta√ß√µes">
      <%= link_to "‚¨áÔ∏è Exportar CSV", admin_emprestimos_path(request.query_parameters.merge(format: :csv)), class: "btn btn-outline-primary" %>
      <%= link_to "üñ®Ô∏è Exportar PDF", admin_emprestimos_path(request.query_parameters.merge(format: :pdf)), class: "btn btn-outline-primary" %>
    </div>

    <%= form_with url: import_admin_emprestimos_path, method: :post, local: true, html: { multipart: true, class: "d-flex flex-column flex-sm-row gap-2 align-items-stretch align-items-sm-center" } do |form| %>
      <div>
        <%= form.file_field :file, accept: ".csv", class: "form-control" %>
      </div>
      <%= form.submit "üì§ Importar CSV", class: "btn btn-success" %>
    <% end %>
  </div>
</div>

<div class="alert alert-info" role="alert">
  <strong>Formato esperado do CSV:</strong> cabe√ßalho com <code>Cliente (email)</code>, <code>Filme</code>, <code>Dias</code>, <code>Valor total</code>, <code>Valor multa</code>. O sistema utiliza o e-mail para encontrar o cliente e define a data prevista adicionando os dias informados √† data atual.
</div>

<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: admin_emprestimos_path, method: :get, local: true, class: "row g-3 align-items-end" do |form| %>
      <div class="col-md-5">
        <%= form.label :q, "Buscar por cliente ou filme", class: "form-label" %>
        <%= form.text_field :q,
                            value: @query,
                            placeholder: "Ex: Jo√£o Silva, Matrix",
                            class: "form-control" %>
      </div>

      <div class="col-md-4">
        <%= form.label :status, "Status", class: "form-label" %>
        <%= form.select :status,
                        options_for_select([
                          ["Todos", ""],
                          ["Somente pendentes", "pendentes"],
                          ["Somente devolvidos", "devolvidos"]
                        ], @status_filter),
                        {},
                        class: "form-select" %>
      </div>

      <div class="col-md-3 d-flex gap-2">
        <%= form.submit "Filtrar", class: "btn btn-primary" %>
        <%= link_to "Limpar", admin_emprestimos_path, class: "btn btn-outline-secondary" %>
      </div>
    <% end %>
  </div>
</div>

<% if @emprestimos.any? %>
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Cliente</th>
          <th>Filme</th>
          <th>M√≠dia</th>
          <th>Data do empr√©stimo</th>
          <th>Devolver at√©</th>
          <th>Devolvido em</th>
          <th>Valor</th>
          <th>Multa</th>
          <th>Status</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @emprestimos.each do |emprestimo| %>
          <% devolvido = emprestimo.data_devolucao_efetiva.present? %>
          <tr>
            <td><%= emprestimo.id %></td>
            <td>
              <strong><%= emprestimo.cliente&.nome || "Cliente sem nome" %></strong><br>
              <small class="text-muted"><%= emprestimo.cliente&.email %></small>
            </td>
            <td><%= emprestimo.copia_filme&.filme&.titulo || "Filme removido" %></td>
            <td><%= emprestimo.copia_filme&.tipo_midia %></td>
            <td>
              <% if emprestimo.data_emprestimo.present? %>
                <%= l emprestimo.data_emprestimo, format: :short %>
              <% else %>
                ‚Äî
              <% end %>
            </td>
            <td>
              <% if emprestimo.data_prevista_devolucao.present? %>
                <%= l emprestimo.data_prevista_devolucao, format: :short %>
              <% else %>
                ‚Äî
              <% end %>
            </td>
            <td>
              <% if emprestimo.data_devolucao_efetiva.present? %>
                <%= l emprestimo.data_devolucao_efetiva, format: :short %>
              <% else %>
                ‚Äî
              <% end %>
            </td>
            <td><%= emprestimo.valor_locacao.present? ? number_to_currency(emprestimo.valor_locacao) : "‚Äî" %></td>
            <td><%= emprestimo.valor_multa.present? ? number_to_currency(emprestimo.valor_multa) : "‚Äî" %></td>
            <td>
              <% badge_class = devolvido ? "bg-success" : "bg-warning text-dark" %>
              <span class="badge <%= badge_class %>">
                <%= devolvido ? "Devolvido" : "Em aberto" %>
              </span>
            </td>
            <td class="text-end">
              <%= link_to "Detalhes", admin_emprestimo_path(emprestimo), class: "btn btn-sm btn-outline-primary" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% else %>
  <div class="alert alert-info">Nenhum empr√©stimo encontrado com os crit√©rios informados.</div>
<% end %>

<div class="mt-4">
  <%= link_to "‚¨ÖÔ∏è Voltar ao Dashboard", admin_root_path, class: "btn btn-secondary" %>
</div>
